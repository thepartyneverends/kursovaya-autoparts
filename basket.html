<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Корзина - AutoParts</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
        }
        
        .cart-item {
            border: 1px solid #dee2e6;
            border-radius: 10px;
            margin-bottom: 15px;
            background: white;
            transition: all 0.2s;
        }
        
        .cart-item:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #dee2e6;
            background: white;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .quantity-input {
            width: 50px;
            text-align: center;
            border: 1px solid #dee2e6;
            border-radius: 5px;
        }
        
        .empty-cart {
            text-align: center;
            padding: 60px 20px;
        }
    </style>
</head>
<body>
    <header class="main-header">
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <div class="collapse navbar-collapse" id="navbarMain">
                    <ul class="navbar-nav me-auto">
                        <li class="nav-item">
                            <a class="nav-link" href="index.html">
                                <i class="bi bi-house-door me-1"></i>Главная
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" href="all-parts.html">
                                <i class="bi bi-gear me-1"></i>Все товары
                            </a>
                        </li>
                    </ul>
                    
                </div>
            </div>
        </nav>
    </header>
    <div class="container py-4">
        <h1 class="mb-4"><i class="bi bi-cart3 me-2"></i>Корзина</h1>
        
        <div class="row">
            <div class="col-lg-8">
                <!-- Список товаров в корзине -->
                <div id="cartItems">
                    <!-- Товары загрузятся динамически -->
                </div>
                
                <div id="emptyCart" class="empty-cart" style="display: none;">
                    <i class="bi bi-cart-x display-1 text-muted mb-3"></i>
                    <h3>Корзина пуста</h3>
                    <p class="text-muted">Добавьте товары из каталога</p>
                    <a href="all-parts.html" class="btn btn-primary">
                        <i class="bi bi-arrow-left me-2"></i>Перейти к товарам
                    </a>
                </div>
            </div>
            
            <div class="col-lg-4">
                <!-- Итого -->
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title mb-3">Итого</h5>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Товаров:</span>
                            <span id="totalItems">0 шт</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-2">
                            <span>Сумма:</span>
                            <span id="subtotal">0 ₽</span>
                        </div>
                        
                        <div class="d-flex justify-content-between mb-3">
                            <span>Доставка:</span>
                            <span id="shipping">0 ₽</span>
                        </div>
                        
                        <hr>
                        
                        <div class="d-flex justify-content-between mb-4">
                            <strong>Общая сумма:</strong>
                            <strong id="totalAmount">0 ₽</strong>
                        </div>
                        
                        <button class="btn btn-primary w-100 mb-2" id="checkoutBtn">
                            <i class="bi bi-credit-card me-2"></i>Оформить заказ
                        </button>
                        
                        <button class="btn btn-outline-danger w-100" id="clearCartBtn">
                            <i class="bi bi-trash me-2"></i>Очистить корзину
                        </button>
                    </div>
                </div>
                
                <!-- Контакты -->
                <div class="card mt-3">
                    <div class="card-body">
                        <h6 class="card-title mb-3">Контактная информация</h6>
                        <div class="mb-2">
                            <i class="bi bi-telephone me-2"></i>8 (949) 555-55-55
                        </div>
                        <div class="mb-2">
                            <i class="bi bi-clock me-2"></i>Ежедневно 9:00-21:00
                        </div>
                        <div>
                            <i class="bi bi-truck me-2"></i>Доставка 1-3 дня
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        class ShoppingCart {
            constructor() {
                this.cart = this.loadCart();
                this.products = {};
                this.init();
            }
            
            init() {
                this.loadProducts();
                this.renderCart();
                this.attachEventListeners();
            }
            
            // Загрузка корзины из localStorage
            loadCart() {
                return JSON.parse(localStorage.getItem('cart') || '[]');
            }
            
            // Сохранение корзины в localStorage
            saveCart() {
                localStorage.setItem('cart', JSON.stringify(this.cart));
            }
            
            // Загрузка данных о товарах из JSON
            async loadProducts() {
                try {
                    const response = await fetch('data/products.json');
                    const data = await response.json();
                    
                    // Создаем объект с товарами для быстрого доступа по ID
                    data.products.forEach(product => {
                        this.products[product.id] = product;
                    });
                    
                    this.renderCart();
                } catch (error) {
                    console.error('Ошибка загрузки товаров:', error);
                }
            }
            
            // Форматирование цены
            formatPrice(price) {
                return price.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
            }
            
            // Рендеринг корзины
            renderCart() {
                const cartItemsContainer = document.getElementById('cartItems');
                const emptyCartContainer = document.getElementById('emptyCart');
                
                if (this.cart.length === 0) {
                    cartItemsContainer.style.display = 'none';
                    emptyCartContainer.style.display = 'block';
                    this.updateTotals();
                    return;
                }
                
                cartItemsContainer.style.display = 'block';
                emptyCartContainer.style.display = 'none';
                
                let cartHtml = '';
                
                this.cart.forEach(item => {
                    const product = this.products[item.id];
                    if (!product) return;
                    
                    const totalPrice = product.price * item.quantity;
                    
                    cartHtml += `
                        <div class="cart-item p-3">
                            <div class="row align-items-center">
                                <div class="col-3 col-md-2">
                                    <img src="${product.image || 'https://via.placeholder.com/100x100/f8f9fa/6c757d?text=Нет+фото'}" 
                                         class="img-fluid rounded" 
                                         alt="${product.name}"
                                         onerror="this.src='https://via.placeholder.com/100x100/f8f9fa/6c757d?text=Нет+фото'">
                                </div>
                                <div class="col-9 col-md-5">
                                    <h6 class="mb-1">${product.name}</h6>
                                    <p class="text-muted small mb-2">${product.description || ''}</p>
                                    <span class="badge bg-light text-dark">${product.category || 'Без категории'}</span>
                                </div>
                                <div class="col-6 col-md-2 mt-3 mt-md-0">
                                    <div class="d-flex align-items-center">
                                        <button class="quantity-btn decrease" data-id="${item.id}">-</button>
                                        <input type="number" 
                                               class="quantity-input mx-2" 
                                               value="${item.quantity}" 
                                               min="1" 
                                               max="${product.stock || 99}"
                                               data-id="${item.id}">
                                        <button class="quantity-btn increase" data-id="${item.id}">+</button>
                                    </div>
                                </div>
                                <div class="col-3 col-md-2 mt-3 mt-md-0 text-end">
                                    <div class="fw-bold">${this.formatPrice(product.price)} ₽</div>
                                    <div class="text-muted small">за шт</div>
                                </div>
                                <div class="col-3 col-md-1 mt-3 mt-md-0 text-end">
                                    <button class="btn btn-sm btn-outline-danger remove-item" data-id="${item.id}">
                                        <i class="bi bi-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="row mt-2">
                                <div class="col-12 text-end">
                                    <strong>Всего: ${this.formatPrice(totalPrice)} ₽</strong>
                                </div>
                            </div>
                        </div>
                    `;
                });
                
                cartItemsContainer.innerHTML = cartHtml;
                this.updateTotals();
                this.attachItemEventListeners();
            }
            
            // Обновление итоговых значений
            updateTotals() {
                const totalItems = this.cart.reduce((sum, item) => sum + item.quantity, 0);
                const subtotal = this.cart.reduce((sum, item) => {
                    const product = this.products[item.id];
                    return sum + (product ? product.price * item.quantity : 0);
                }, 0);
                
                // Бесплатная доставка от 5000 ₽
                const shipping = subtotal >= 5000 ? 0 : 500;
                const totalAmount = subtotal + shipping;
                
                document.getElementById('totalItems').textContent = `${totalItems} шт`;
                document.getElementById('subtotal').textContent = `${this.formatPrice(subtotal)} ₽`;
                document.getElementById('shipping').textContent = shipping === 0 ? 'Бесплатно' : `${this.formatPrice(shipping)} ₽`;
                document.getElementById('totalAmount').textContent = `${this.formatPrice(totalAmount)} ₽`;
                
                // Обновляем счетчик в localStorage (для других страниц)
                localStorage.setItem('cart_count', totalItems);
                
                // Дополнительно: отправляем событие для обновления счетчика в других вкладках
                window.dispatchEvent(new Event('storage'));
            }
            
            // Обработчики событий
            attachEventListeners() {
                // Очистка корзины
                document.getElementById('clearCartBtn').addEventListener('click', () => {
                    if (confirm('Вы уверены, что хотите очистить корзину?')) {
                        this.cart = [];
                        this.saveCart();
                        this.renderCart();
                    }
                });
                
                // Оформление заказа
                document.getElementById('checkoutBtn').addEventListener('click', () => {
                    if (this.cart.length === 0) {
                        alert('Корзина пуста!');
                        return;
                    }
                    
                    this.processOrder();
                });
                
                // Обновление при изменении в других вкладках
                window.addEventListener('storage', () => {
                    this.cart = this.loadCart();
                    this.renderCart();
                });
            }
            
            // Обработчики для товаров в корзине
            attachItemEventListeners() {
                // Увеличение количества
                document.querySelectorAll('.increase').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.target.dataset.id;
                        this.updateQuantity(productId, 1);
                    });
                });
                
                // Уменьшение количества
                document.querySelectorAll('.decrease').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.target.dataset.id;
                        this.updateQuantity(productId, -1);
                    });
                });
                
                // Изменение количества через input
                document.querySelectorAll('.quantity-input').forEach(input => {
                    input.addEventListener('change', (e) => {
                        const productId = e.target.dataset.id;
                        const newQuantity = parseInt(e.target.value) || 1;
                        const product = this.products[productId];
                        
                        if (product && product.stock && newQuantity > product.stock) {
                            alert(`Доступно только ${product.stock} шт.`);
                            e.target.value = product.stock;
                            this.setQuantity(productId, product.stock);
                        } else {
                            this.setQuantity(productId, newQuantity);
                        }
                    });
                });
                
                // Удаление товара
                document.querySelectorAll('.remove-item').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const productId = e.target.closest('button').dataset.id;
                        this.removeItem(productId);
                    });
                });
            }
            
            // Методы работы с корзиной
            updateQuantity(productId, change) {
                const itemIndex = this.cart.findIndex(item => item.id == productId);
                if (itemIndex === -1) return;
                
                const newQuantity = this.cart[itemIndex].quantity + change;
                
                if (newQuantity < 1) {
                    this.removeItem(productId);
                    return;
                }
                
                const product = this.products[productId];
                if (product && product.stock && newQuantity > product.stock) {
                    alert(`Доступно только ${product.stock} шт.`);
                    this.cart[itemIndex].quantity = product.stock;
                } else {
                    this.cart[itemIndex].quantity = newQuantity;
                }
                
                this.saveCart();
                this.renderCart();
            }
            
            setQuantity(productId, quantity) {
                const itemIndex = this.cart.findIndex(item => item.id == productId);
                if (itemIndex === -1) return;
                
                if (quantity < 1) {
                    this.removeItem(productId);
                    return;
                }
                
                this.cart[itemIndex].quantity = quantity;
                this.saveCart();
                this.renderCart();
            }
            
            removeItem(productId) {
                this.cart = this.cart.filter(item => item.id != productId);
                this.saveCart();
                this.renderCart();
            }
            
            // Оформление заказа (демо-версия)
            processOrder() {
                const orderData = {
                    items: this.cart.map(item => ({
                        id: item.id,
                        quantity: item.quantity,
                        product: this.products[item.id]
                    })),
                    total: this.cart.reduce((sum, item) => {
                        const product = this.products[item.id];
                        return sum + (product ? product.price * item.quantity : 0);
                    }, 0),
                    date: new Date().toISOString(),
                    orderId: 'ORD-' + Date.now()
                };
                
                // Сохраняем заказ в localStorage
                const orders = JSON.parse(localStorage.getItem('orders') || '[]');
                orders.push(orderData);
                localStorage.setItem('orders', JSON.stringify(orders));
                
                // Очищаем корзину
                this.cart = [];
                this.saveCart();
                
                // Показываем сообщение
                alert(`Заказ оформлен!\nНомер заказа: ${orderData.orderId}\nСумма: ${this.formatPrice(orderData.total)} ₽\n\nС вами свяжется менеджер для подтверждения.`);
                
                this.renderCart();
            }
        }
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', () => {
            const cart = new ShoppingCart();
            
            // Делаем доступным для отладки
            window.cart = cart;
        });
    </script>
</body>
</html>